<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NASA Embiggen Your Eyes</title>
  <!-- Bootstrap -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <link rel="stylesheet" href="/static/styles.css">
  
  <!-- OpenSeadragon -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
  <style>
    body { background:#111; color:#fff; }
    #viewer { height: 90vh; background:black; }
    .dataset-item { cursor:pointer; }
    .label-dot {
      width:10px; height:10px; border-radius:50%;
      background:red; position:absolute;
    }
  </style>
</head>
<body class="container-fluid">

  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 bg-dark p-3">
      <h2 class="sidebar-title mb-4">NASA Embiggen Your Eyes</h2>

      <h4 class="text-light">Datasets</h4>
      <ul id="dataset-list" class="list-group mb-3"></ul>
    

      <h5 class="text-light mt-3">Search</h5>
        <div class="input-group mb-2">
        <input type="text" id="searchQuery" class="form-control" placeholder="Search..">
        <button class="btn btn-sm submit" onclick="searchLabels()">Find</button>
        </div>
      
    </div>

    <!-- Main Viewer -->
    <div class="col-md-9">
      <div id="viewer"></div>
    </div>
  </div>

  <script>
    let viewer;
    let currentDataset = null;
    let currentImage = null;

    // Initialize Viewer
    function initViewer(imageId, info) {
      if (viewer) viewer.destroy();
      viewer = OpenSeadragon({
        id: "viewer",
        prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
        tileSources: {
          height: info.original_height,
          width: info.original_width,
          tileSize: 256,
          minLevel: 0,
          maxLevel: info.levels.length - 1,
          getTileUrl: (level, x, y) =>
            `/images/${imageId}/tile/${level}/${x}/${y}`
        },

        // enable mouse scroll zoom
        gestureSettingsMouse: {
            scrollToZoom: true,     
            clickToZoom: false
        },

        //enable touch screen zoom
        gestureSettingsTouch: {
            pinchToZoom: true,     
            flickEnabled: true
        },

        showNavigator: true,
        showNavigationControl: true
      });

      // Annotation tool - click: add label
      viewer.addHandler("canvas-click", async function(e) {
        const point = viewer.viewport.pointFromPixel(e.position);
        const imgCoords = viewer.viewport.viewportToImageCoordinates(point);

        await fetch(`/datasets/${currentDataset}/labels/?x=${imgCoords.x}&y=${imgCoords.y}&label=feature&user_id=guest`, { method: "POST" });
        loadLabels(currentDataset);
      });
    }

    // Load Datasets
    async function loadDatasets() {
      const res = await fetch("/datasets/");
      const datasets = await res.json();
      const list = document.getElementById("dataset-list");
      list.innerHTML = "";

      datasets.forEach(ds => {
        const li = document.createElement("li");
        li.className = "list-group-item list-group-item-action dataset-item";
        li.textContent = ds.name;
        li.onclick = async () => {
          currentDataset = ds.id;
          // Load first image
          const resImg = await fetch(`/datasets/${ds.id}/images/`);
          const images = await resImg.json();
          if (images.length > 0) {
            currentImage = images[0].id;
            const infoRes = await fetch(`/images/${currentImage}/pyramid-info`);
            const info = await infoRes.json();
            initViewer(currentImage, info);
            loadLabels(ds.id);
          }
        };
        list.appendChild(li);
      });
    }

    // Load Labels
    async function loadLabels(datasetId) {
      if(!viewer) return;
      viewer.clearOverlays();
      const res = await fetch(`/datasets/${datasetId}/labels/`);
      const labels = await res.json();

      labels.forEach(lbl => {
        const dot = document.createElement("div");
        dot.className = "label-dot";

        const viewportPoint = viewer.viewport.imageToViewportCoordinates(lbl.x, lbl.y);

        viewer.addOverlay({
          element: dot,
          location: viewportPoint
        });
      });
    }

    // Search
    async function searchLabels() {
      const q = document.getElementById("searchQuery").value;
      if (!currentDataset) return;
      const res = await fetch(`/search-features?query=${q}&dataset_id=${currentDataset}`);
      const results = await res.json();
      viewer.clearOverlays();

      results.forEach(lbl => {
    const dot = document.createElement("div");
    dot.className = "label-dot";
    dot.style.background = "yellow"; // highlight search results

    const viewportPoint = viewer.viewport.imageToViewportCoordinates(lbl.x, lbl.y);
    viewer.addOverlay({ element: dot, location: viewportPoint });
    });
      alert(`Found ${results.length} matching labels for "${q}"`);
    }

    loadDatasets();
  </script>
</body>
</html>

<html lang="en" crxemulator="" crosspilot="">
    <plasmo-csui></plasmo-csui>
    <head>
        <style>body {transition: opacity ease-in 0.2s; } 
        body[unresolved] {opacity: 0; display: block; overflow: hidden; position: relative; } 
        </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NASA Embiggen Your Eyes - Explore the Universe</title>
  <!-- Bootstrap -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
   <link rel="stylesheet" href="/static/styles.css">
  
  <!-- OpenSeadragon -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script><style type="text/css" id="operaUserStyle">
  video {
    filter: -opera-shader(url(data:text/plain;base64,Ly8gaHR0cHM6Ly9naXRodWIuY29tL0dQVU9wZW4tRWZmZWN0cy9GaWRlbGl0eUZYLUNBUwovLyB2MwoKdW5pZm9ybSBzaGFkZXIgaUNodW5rOwp1bmlmb3JtIGZsb2F0MiBpQ2h1bmtTaXplOwp1bmlmb3JtIGZsb2F0MiBpTW91c2U7CnVuaWZvcm0gZmxvYXQgaUFyZ3NbMV07Cgpjb25zdCBmbG9hdCBFUFNJT04gPSAwLjE7CmNvbnN0IGZsb2F0IFZfTUlOID0gMDsKY29uc3QgZmxvYXQgVl9MT1cgPSAwLjI1Owpjb25zdCBmbG9hdCBWX01FRCA9IDAuNTsKY29uc3QgZmxvYXQgVl9ISUdIID0gMC43NTsKY29uc3QgZmxvYXQgVl9NQVggPSAxOwoKY29uc3QgZmxvYXQgVEhSRVNIT0xEX0FSRUEgPSA4MDAgKiA2MDA7CmNvbnN0IGZsb2F0IE1JTl9BUkVBID0gNDAwICogMTAwOwpjb25zdCBmbG9hdCBNSU5fU1RSSVAgPSAyMDsKY29uc3QgZmxvYXQgTUFSR0lOID0gMTsKCmZsb2F0MyBwaXhlbChpbnQgeCwgaW50IHksIGZsb2F0MiB4eSkgewogICAgcmV0dXJuIGlDaHVuay5ldmFsKHh5ICsgZmxvYXQyKHgsIHkpKS5yZ2I7Cn0KCmZsb2F0MyBzaGFycGVuKGZsb2F0MiB4eSkgewogICAgZmxvYXQzIGYgPQogICAgICAgIHBpeGVsKC0xLCAtMSwgeHkpICogIDEgKwogICAgICAgIHBpeGVsKCAwLCAtMSwgeHkpICogLTEgKwogICAgICAgIHBpeGVsKCAxLCAtMSwgeHkpICogIDEgKwoKICAgICAgICBwaXhlbCgtMSwgMCwgeHkpICogLTEgICsKICAgICAgICBwaXhlbCggMCwgMCwgeHkpICogLTEgICsKICAgICAgICBwaXhlbCggMSwgMCwgeHkpICogLTEgICsKCiAgICAgICAgcGl4ZWwoLTEsIDEsIHh5KSAqIDEgICArCiAgICAgICAgcGl4ZWwoIDAsIDEsIHh5KSAqIC0xICArCiAgICAgICAgcGl4ZWwoIDEsIDEsIHh5KSAqIDE7CiAgICByZXR1cm4gZiAvIC0xOwp9CgpmbG9hdDQgUkdYMihmbG9hdDIgeHkpIHsKICAgIGZsb2F0NCBjb2xvciA9IGlDaHVuay5ldmFsKHh5KTsKCiAgICBpZiAoaUNodW5rU2l6ZS54ICogaUNodW5rU2l6ZS55IDwgTUlOX0FSRUEpIHsKICAgICAgICByZXR1cm4gY29sb3I7CiAgICB9CgogICAgaWYgKGlDaHVua1NpemUueSA8IE1JTl9TVFJJUCB8fCBpQ2h1bmtTaXplLnggPCBNSU5fU1RSSVApIHsKICAgICAgICByZXR1cm4gY29sb3I7CiAgICB9CgogICAgaWYgKHh5LnggPCBNQVJHSU4gfHwgeHkueCA+IChpQ2h1bmtTaXplLnggLSBNQVJHSU4pIHx8CiAgICAgICAgeHkueSA8IE1BUkdJTiB8fCB4eS55ID4gKGlDaHVua1NpemUueSAtIE1BUkdJTikpIHsKICAgICAgICByZXR1cm4gY29sb3I7CiAgICB9CgogICAgcmV0dXJuIGZsb2F0NChzaGFycGVuKHh5KSwgMSk7Cn0KCmZsb2F0IG1pbjMoZmxvYXQgeCwgZmxvYXQgeSwgZmxvYXQgeikgewogICAgcmV0dXJuIG1pbih4LCBtaW4oeSwgeikpOwp9CgpmbG9hdCBtYXgzKGZsb2F0IHgsIGZsb2F0IHksIGZsb2F0IHopIHsKICAgIHJldHVybiBtYXgoeCwgbWF4KHksIHopKTsKfQoKZmxvYXQgcmNwKGZsb2F0IHYpIHsKICAgIHJldHVybiAxIC8gdjsKfQoKZmxvYXQzIFJHWDMoZmxvYXQyIHh5LCBmbG9hdCBzdHJlbmd0aCkgewogICAgZmxvYXQzIGEgPSBwaXhlbCgtMSwgLTEsIHh5KTsKICAgIGZsb2F0MyBiID0gcGl4ZWwoIDAsIC0xLCB4eSk7CiAgICBmbG9hdDMgYyA9IHBpeGVsKCAxLCAtMSwgeHkpOwoKICAgIGZsb2F0MyBkID0gcGl4ZWwoLTEsIDAsIHh5KTsKICAgIGZsb2F0MyBlID0gcGl4ZWwoIDAsIDAsIHh5KTsKICAgIGZsb2F0MyBmID0gcGl4ZWwoIDEsIDAsIHh5KTsKCiAgICBmbG9hdDMgZyA9IHBpeGVsKC0xLCAxLCB4eSk7CiAgICBmbG9hdDMgaCA9IHBpeGVsKCAwLCAxLCB4eSk7CiAgICBmbG9hdDMgaSA9IHBpeGVsKCAxLCAxLCB4eSk7CgogICAgZmxvYXQgbW5SID0gbWluMyhtaW4zKGQuciwgZS5yLCBmLnIpLCBiLnIsIGgucik7CiAgICBmbG9hdhdCBtbkcgPSBtaW4zKG1pbjMoZC5nLCBlLmcsIGYuZyksIGIuZywgaC5nKTsKICAgIGZsb2F0IG1uQiA9IG1pbjMobWluMyhkLmIsIGUuYiwgZi5iKSwgYi5iLCBoLmIpOwoKICAgIGZsb2F0IG1uUjIgPSBtaW4zKG1pbjMobW5SLCBhLnIsIGMuciksIGcuciwgaS5yKTsKICAgIGZsb2F0IG1uRzIgPSBtaW4zKG1pbjMobW5HLCBhLmcsIGMuZyksIGcuZywgaS5nKTsKICAgIGZsb2F0IG1uQjIgPSBtaW4zKG1pbjMobW5CLCBhLmIsIGMuYiksIGcuYiwgaS5iKTsKCiAgICBtblIgPSBtblIgKyBtblIyOwogICAgbW5HID0gbW5HICsgbW5HMjsKICAgIG1uQiA9IG1uQiArIG1uQjI7CgogICAgZmxvYXQgbXhSID0gbWF4MyhtYXgzKGQuciwgZS5yLCBmLnIpLCBiLnIsIGgucik7CiAgICBmbG9hdhdCBteEcgPSBtYXgzKG1heDMoZC5nLCBlLmcsIGYuZyksIGIuZywgaC5nKTsKICAgIGZsb2F0IG14QiA9IG1heDMobWF4MyhkLmIsIGUuYiwgZi5iKSwgYi5iLCBoLmIpOwoKICAgIGZsb2F0IG14UjIgPSBtYXgzKG1heDMobXhSLCBhLnIsIGMuciksIGcuciwgaS5yKTsKICAgIGZsb2F0IG14RzIgPSBtYXgzKG1heDMobXhHLCBhLmcsIGMuZyksIGcuZywgaS5nKTsKICAgIGZsb2F0IG14QjIgPSBtYXgzKG1heDMobXhCLCBhLmIsIGMuYiksIGcuYiwgaS5iKTsKCiAgICBteFIgPSBteFIgKyBteFIyOwogICAgbXhHID0gbXhHICsgbXhHMjsKICAgIG14QiA9IG14QiArIG14QjI7CgogICAgZmxvYXQgcmNwTVIgPSByY3AobXhSKTsKICAgIGZsb2F0IHJjcE1HID0gcmNwKG14Ryk7CiAgICBmbG9hdCByY3BNQiA9IHJjcChteEIpOwoKICAgIGZsb2F0IGFtcFIgPSBzYXR1cmF0ZShtaW4obW5SLCAyIC0gbXhSKSAqIHJjcE1SKTsKICAgIGZsb2F0IGFtcEcgPSBzYXR1cmF0ZShtaW4obW5HLCAyIC0gbXhHKSAqIHJjcE1HKTsKICAgIGZsb2F0IGFtcEIgPSBzYXR1cmF0ZShtaW4obW5CLCAyIC0gbXhCKSAqIHJjcE1CKTsKCiAgICBhbXBSID0gc3FydChhbXBSKTsKICAgIGFtcEcgPSBzcXJ0KGFtcEcpOwogICAgYW1wQiA9IHNxcnQoYW1wQik7CgogICAgZmxvYXQgcGVhayA9IC1yY3AobWl4KDgsIDUsIHN0cmVuZ3RoKSk7CgogICAgZmxvYXQgd1IgPSBhbXBSICogcGVhazsKICAgIGZsb2F0IHdHID0gYW1wRyAqIHBlYWs7CiAgICBmbG9hdCB3QiA9IGFtcEIgKiBwZWFrOwoKICAgIGZsb2F0IHJjcFdlaWdodFIgPSByY3AoMSArIDQgKiB3Uik7CiAgICBmbG9hdCByY3BXZWlnaHRHID0gcmNwKDEgKyA0ICogd0cpOwogICAgZmxvYXQgcmNwV2VpZ2h0QiA9IHJjcCgxICsgNCAqIHdCKTsKCiAgICByZXR1cm4gZmxvYXQzKAogICAgICAgIHNhdHVyYXRlKChiLnIgKiB3UiArIGQuciAqIHdSICsgZi5yICogd1IgKyBoLnIgKiB3UiArIGUucikgKiByY3BXZWlnaHRSKSwKICAgICAgICBzYXR1cmF0ZSgoYi5nICogd0cgKyBkLmcgKiB3RyArIGYuZyAqIHdHICsgaC5nICogd0cgKyBlLmcpICogcmNwV2VpZ2h0RyksCiAgICAgICAgc2F0dXJhdGUoKGIuYiAqIHdCICsgZC5iICogd0IgKyBmLmIgKiB3QiArIGguYiAqIHdCICsgZS5iKSAqIHJjcFdlaWdodEIpKTsKfQoKCmZsb2F0NCBtYWluKGZsb2F0MiB4eSkgewoKICAgIGZsb2F0NCBvcmlnaW5hbENvbG9yID0gaUNodW5rLmV2YWwoeHkpOwogICAgaWYgKG9yaWdpbmFsQ29sb3IuYSA8IDEpIHsKICAgICAgICByZXR1cm4gaUNodW5rLmV2YWwoeHkpOwogICAgfQoKICAgIGZsb2F0IGludGVuc2l0eSA9IGlBcmdzWzBdOwogICAgZmxvYXQgc3RyZW5ndGggPSAwOwogICAgZmxvYXQzIGNvbG9yOwoKICAgIGlmIChpbnRlbnNpdHkgPCBWX01JTiArIEVQU0lPTikgewogICAgICAgIHN0cmVuZ3RoID0gMC4xMDsKICAgICAgICBjb2xvciA9IFJHWDMoeHksIHN0cmVuZ3RoKTsKCiAgICB9IGVsc2UgaWYgKGludGVuc2l0eSA+IFZfTE9XIC0gRVBTSU9OICYmIGludGVuc2l0eSA8IFZfTE9XICsgRVBTSU9OKSB7CiAgICAgICAgc3RyZW5ndGggPSAwLjMzOwogICAgICAgIGNvbG9yID0gUkdYMyh4eSwgc3rYW5ndGgpOwoKICAgIH0gZWxzZSBpZiAoaW50ZW5zaXR5ID4gVl9NRUQgLSBFUFNJT04gJiYgaW50ZW5zaXR5IDwgVl9NRUQgKyBFUFNJT04pIHsKICAgICAgICBzdHJlbmd0aCA9IDAuNTsKICAgICAgICBjb2xvciA9IFJHWDMoeHksIHN0cmVuZ3RoKTsKCiAgICB9IGVsc2UgaWYgKGludGVuc2l0eSA+IFZfSElHSCAtIEVQU0lPTiAmJiBpbnRlbnNpdHkgPCBWX0hJR0ggKyBFUFNJT04pIHsKICAgICAgICBzdHJlbmd0aCA9IDAuOTk7CiAgICAgICAgY29sb3IgPSBSR1gzKHh5LCBzdHJlbmd0aCk7CgogICAgfSBlbHNlIGlmIChpbnRlbnNpdHkgPiBWX01BWCAtIEVQU0lPTikgewogICAgICAgIHN0cmVuZ3RoID0gMTsKICAgICAgICBjb2xvciA9IFJHWDIoeHkpLnJnYjsKICAgIH0KCiAgICByZXR1cm4gZmxvYXQ0KGNvbG9yLCBvcmlnaW5hbENvbG9yLmEpOwp9) -opera-args(050 calc(env(-opera-accent-color-r 255)/255) calc(env(-opera-accent-color-g, 255)/255) calc(env(-opera-accent-color-b, 255)/255)));
  }
</style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body { 
      background: linear-gradient(135deg, #0b0c10 0%, #162447 50%, #1f2833 100%);
      color: #e0e1dd; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }
    #viewer { 
      height: 85vh; 
      background: radial-gradient(circle, #000000 0%, #1a1a1a 100%);
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(102, 252, 241, 0.2);
    }
    .dataset-item { 
      cursor: pointer; 
      transition: all 0.3s ease;
      border-left: 3px solid transparent;
    }
    .dataset-item:hover {
      background: #45a29e !important;
      border-left: 3px solid #66fcf1;
      transform: translateX(5px);
    }
    .label-dot {
      width: 12px; 
      height: 12px; 
      border-radius: 50%;
      background: #00ffff;
      position: absolute;
      box-shadow: 0 0 8px #00ffff;
      border: 2px solid #0b0c10;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .label-dot:hover {
      transform: scale(1.5);
    }
    .navbar-brand {
      font-weight: bold;
      background: linear-gradient(90deg, #66fcf1, #45a29e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 15px rgba(102, 252, 241, 0.3);
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 252, 241, 0.1);
      border-radius: 15px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      border-color: rgba(102, 252, 241, 0.3);
    }
    .feature-icon {
      font-size: 2rem;
      color: #66fcf1;
      margin-bottom: 15px;
    }
    .stats-card {
      text-align: center;
      padding: 20px;
    }
    .stats-number {
      font-size: 2.5rem;
      font-weight: bold;
      color: #66fcf1;
      text-shadow: 0 0 10px rgba(102, 252, 241, 0.5);
    }
    .loading-spinner {
      display: none;
      width: 3rem;
      height: 3rem;
      border: 4px solid rgba(102, 252, 241, 0.3);
      border-top: 4px solid #66fcf1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      background: #45a29e;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      transform: translateX(200%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .image-info {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }
  </style>
<style type="text/css"></style><style>
      .ellipsis-animation {
        display: inline-flex;
        width: 1.5em;
        justify-content: flex-start;
      }
      .ellipsis-animation .dot {
        animation: dot 1.5s infinite;
      }
      .ellipsis-animation .dot:nth-child(1) {
        animation-delay: 0s;
      }
      .ellipsis-animation .dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .ellipsis-animation .dot:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes dot {
        0%, 100% { opacity: 0; }
        50% { opacity: 1; }
      }
    </style></head>
<body cz-shortcut-listen="true">
  <!-- Notification Container -->
  <div id="notification" class="notification"></div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-telescope me-2"></i>NASA Embiggen Your Eyes
      </a>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="card p-3">
          <h2 class="sidebar-title mb-4 text-center"><i class="fas fa-database me-2"></i>Datasets</h2>
          
          <!-- Stats Cards -->
          <div class="row mb-4">
            <div class="col-6">
              <div class="card stats-card">
                <div class="stats-number" id="dataset-count">0</div>
                <div class="text-white">Datasets</div>
              </div>
            </div>
            <div class="col-6">
              <div class="card stats-card">
                <div class="stats-number" id="image-count">0</div>
                <div class="text-white">Images</div>
              </div>
            </div>
          </div>

          <!-- Dataset List -->
          <h4 class="text-light"><i class="fas fa-folder me-2"></i>Available Datasets</h4>
          <div id="loading-datasets" class="loading-spinner" style="display: none;"></div>
          <ul id="dataset-list" class="list-group mb-3">
            <!-- Datasets will be loaded dynamically by JavaScript -->
          </ul>
          
          <!-- Search Section -->
          <div class="search-container mt-4">
            <h5 class="text-light"><i class="fas fa-search me-2"></i>Search Features</h5>
            <div class="input-group mb-2">
              <input type="text" id="searchQuery" class="form-control" placeholder="Search labels...">
              <button class="btn btn-sm submit" onclick="searchLabels()">
                <i class="fas fa-search"></i> Find
              </button>
            </div>
            <div class="form-text text-white-50">
              Search for labeled features in current dataset
            </div>
          </div>
          
          <!-- Annotation Tools -->
          <div class="mt-4">
            <h5 class="text-light"><i class="fas fa-pencil-alt me-2"></i>Annotation Tools</h5>
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="toggleAnnotationMode()">
                <i class="fas fa-mouse-pointer me-1"></i>Toggle Annotation Mode
              </button>
              <button class="btn btn-warning" onclick="initiateMLAnalysis()">
                <i class="fas fa-robot me-1"></i>Run ML Analysis
              </button>
              <button class="btn btn-outline-secondary" onclick="clearLabels()">
                <i class="fas fa-trash me-1"></i>Clear All Labels
              </button>
            </div>
          </div>
        </div>
        
        <!-- Feature Highlights -->
        <div class="card p-3 mt-4">
          <h5 class="text-light text-center"><i class="fas fa-star me-2"></i>Innovative Features</h5>
          <div class="text-center">
            <div class="feature-icon">
              <i class="fas fa-infinity"></i>
            </div>
            <p class="text-white-50">Deep Zoom Technology</p>
            
            <div class="feature-icon">
              <i class="fas fa-robot"></i>
            </div>
            <p class="text-white-50">AI-Powered Enhancement</p>
            
            <div class="feature-icon">
              <i class="fas fa-users"></i>
            </div>
            <p class="text-white-50">Collaborative Labeling</p>
          </div>
        </div>
      </div>

      <!-- Main Viewer -->
      <div class="col-md-9">
        <div class="card p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class= "text-light"id="current-dataset-title">Select a Dataset</h3>
            <div>
              <button class="btn btn-sm btn-outline-light me-2" onclick="toggleFullscreen()">
                <i class="fas fa-expand"></i>
              </button>
              <button class="btn btn-sm btn-outline-light" onclick="downloadImage()">
                <i class="fas fa-download"></i>
              </button>
            </div>
          </div>
          
          <div id="loading-viewer" class="loading-spinner" style="display: none;"></div>
          <div id="viewer">
            <div class="openseadragon-container" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; width: 100%; height: 100%; overflow: hidden; left: 0px; top: 0px; text-align: left; touch-action: none; pointer-events: auto;">
              <div class="openseadragon-canvas" tabindex="0" dir="ltr" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; width: 100%; height: 100%; overflow: hidden; top: 0px; left: 0px; touch-action: none; pointer-events: auto; text-align: left;">
                <canvas width="865" height="785" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; width: 100%; height: 100%; pointer-events: none; touch-action: none;"></canvas>
                <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static;"></div>
              </div>
              <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; left: 0px; top: 0px;">
                <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; display: inline-block;">
                  <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; display: inline-block; touch-action: none; pointer-events: auto;">
                    <div title="Zoom in" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; touch-action: none; display: inline-block; pointer-events: auto;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomin_rest.png" alt="Zoom in" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; pointer-events: none;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomin_grouphover.png" alt="Zoom in" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; opacity: 0;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomin_hover.png" alt="Zoom in" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomin_pressed.png" alt="Zoom in" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                    </div>
                    <div title="Zoom out" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; touch-action: none; display: inline-block; pointer-events: auto;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomout_rest.png" alt="Zoom out" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; pointer-events: none;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomout_grouphover.png" alt="Zoom out" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; opacity: 0;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomout_hover.png" alt="Zoom out" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                      <img src="https://openseadragon.github.io/openseadragon/images/zoomout_pressed.png" alt="Zoom out" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                    </div>
                    <div title="Go home" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; touch-action: none; display: inline-block; pointer-events: auto;">
                      <img src="https://openseadragon.github.io/openseadragon/images/home_rest.png" alt="Go home" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; pointer-events: none;">
                      <img src="https://openseadragon.github.io/openseadragon/images/home_grouphover.png" alt="Go home" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; opacity: 0;">
                      <img src="https://openseadragon.github.io/openseadragon/images/home_hover.png" alt="Go home" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                      <img src="https://openseadragon.github.io/openseadragon/images/home_pressed.png" alt="Go home" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                    </div>
                    <div title="Toggle full page" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; touch-action: none; display: inline-block; pointer-events: auto;">
                      <img src="https://openseadragon.github.io/openseadragon/images/fullpage_rest.png" alt="Toggle full page" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; pointer-events: none;">
                      <img src="https://openseadragon.github.io/openseadragon/images/fullpage_grouphover.png" alt="Toggle full page" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; opacity: 0;">
                      <img src="https://openseadragon.github.io/openseadragon/images/fullpage_hover.png" alt="Toggle full page" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                      <img src="https://openseadragon.github.io/openseadragon/images/fullpage_pressed.png" alt="Toggle full page" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; pointer-events: none; top: 0px; left: 0px; visibility: hidden;">
                    </div>
                  </div>
                </div>
              </div>
              <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; right: 0px; top: 0px;"></div>
              <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; right: 0px; bottom: 0px;">
                <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; display: inline-block;">
                  <div id="navigator-1759328219232" class=" navigator" style="background: rgb(0, 0, 0); border: 2px solid rgb(85, 85, 85); margin: 0px; padding: 0px; position: relative; touch-action: none; opacity: 0.8; overflow: hidden; display: inline-block; width: 120px; height: 100px; pointer-events: auto;">
                    <div class="openseadragon-container" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: relative; width: 100%; height: 100%; overflow: hidden; left: 0px; top: 0px; text-align: left; touch-action: none; pointer-events: none;">
                      <div class="openseadragon-canvas" tabindex="-1" dir="ltr" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; width: 100%; height: 100%; overflow: hidden; top: 0px; left: 0px; touch-action: none; pointer-events: none; text-align: left;">
                        <canvas width="116" height="96" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; width: 100%; height: 100%; pointer-events: none; touch-action: none;"></canvas>
                        <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static;"></div>
                      </div>
                      <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; left: 0px; top: 0px;"></div>
                      <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; right: 0px; top: 0px;"></div>
                      <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; right: 0px; bottom: 0px;"></div>
                      <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; left: 0px; bottom: 0px;"></div>
                      <div id="navigator-1759328219232-displayregioncontainer" class="displayregioncontainer" style="background: none transparent; border: none; margin: 0px; padding: 0px; position: static; width: 100%; height: 100%; pointer-events: none; touch-action: none; transform: rotate(0deg);">
                        <div id="navigator-1759328219232-displayregion" class="displayregion" style="background: transparent; border: 2px solid rgb(153, 0, 0); margin: 0px; padding: 0px; position: relative; top: 0px; left: -4.06px; font-size: 0px; overflow: hidden; float: left; z-index: 999999999; cursor: default; box-sizing: content-box; pointer-events: none; touch-action: none; transform: rotate(0deg); display: block; width: 121px; height: 93px;"></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="background: none transparent; border: none; margin: 0px; padding: 0px; position: absolute; left: 0px; bottom: 0px;"></div>
            </div>
          </div>

          <!-- Image Info -->
          <div id="image-info" class="image-info" style="display: block;">
            <div class="row text-light">
              <div class="col-md-4">
                <strong>Dimensions:</strong> <span id="image-dimensions">0 × 0</span>
              </div>
              <div class="col-md-4">
                <strong>Type:</strong> <span id="image-type">FITS</span>
              </div>
              <div class="col-md-4">
              </div>
            </div>
          </div>
          
          <!-- Labels Table -->
          <div id="labels-table-container" class="mt-4" style="display: block;">
            <h5 class="text-light mb-2"><i class="fas fa-tags me-2"></i>Dataset Labels</h5>
            <div class="table-responsive">
              <table id="labels-table" class="table table-dark table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Label</th>
                    <th>Description</th>
                    <th>Position (X,Y)</th>
                    <th>User</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="labels-table-body">
                  <!-- Labels will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="text-center text-muted py-4 mt-4">
    <div class="container">
      <p>NASA Embiggen Your Eyes - Explore the Universe in High Resolution</p>
      <p class="small">Powered by FastAPI, OpenSeadragon, and Python</p>
    </div>
  </footer>

  <script>
    let viewer;
    let currentDataset = null;
    let currentImage = null;
    let annotationMode = false;
    let datasets = [];
    let images = [];

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.className = 'notification show';
      notification.style.background = type === 'error' ? '#e74c3c' : '#45a29e';
      
      setTimeout(() => {
        notification.className = 'notification';
      }, 3000);
    }

    // Toggle annotation mode
    function toggleAnnotationMode() {
      annotationMode = !annotationMode;
      showNotification(annotationMode ? 'Annotation mode enabled. Click on image to label features.' : 'Annotation mode disabled.');
      loadLabels(currentDataset);
      
    }

    // Clear all labels
    async function clearLabels() {
      if (!currentDataset) {
        showNotification('Please select a dataset first.', 'error');
        return;
      }
      
      if (confirm('Are you sure you want to clear all labels in this dataset?')) {
    try {
      const response = await fetch(`/datasets/${currentDataset}/labels/`, {
        method: "DELETE"
      });

      if (response.ok) {
        if (viewer) viewer.clearOverlays();
        showNotification('All labels cleared from backend.');
        loadLabels(currentDataset);
      } else {
        showNotification('Error clearing labels from backend.', 'error');
      }
    } catch (error) {
      showNotification('Network error while clearing labels.', 'error');
    }
  }
}

    // Toggle fullscreen
    function toggleFullscreen() {
      const viewerElement = document.getElementById('viewer');
      if (!document.fullscreenElement) {
        viewerElement.requestFullscreen().catch(err => {
          showNotification('Error attempting to enable fullscreen: ' + err.message, 'error');
        });
      } else {
        document.exitFullscreen();
      }
    }

    // Download image
    function downloadImage() {
      if (!currentImage) {
        showNotification('No image selected.', 'error');
        return;
      }
      showNotification('Download feature would be implemented in a production environment.');
    }

    // Initialize Viewer
    function initViewer(imageId, info, datasetID) {
      // Show loading viewer when starting to load the image
      document.getElementById('loading-viewer').style.display = 'block';
      
      // Clear the timeout if we already have one running
      if (window.loadingTimeout) {
        clearTimeout(window.loadingTimeout);
      }
      
      if (viewer) viewer.destroy();

      let imageUrl = "";
      if(datasetID === 1){
        imageUrl = "/backend/uploads/9c226034-e6e0-4891-89cb-ff08e8b3857c.png"
      }
      else if (datasetID === 2) {
        imageUrl = "/backend/uploads/ec81fe45-419b-41f2-bef8-d625009efffc.jpg";
      } else if (datasetID === 3) {
        imageUrl = "/backend/uploads/Galaxy 9mb.jpg";
      } else {
        // default / test URL
        imageUrl = "https://assets.science.nasa.gov/dynamicimage/assets/science/missions/hubble/releases/2007/12/STScI-01EVT6PMZQSAE9S5C3K9Z2TENG.tif?w=1800&h=824&fit=crop&crop=faces%2Cfocalpoint";
      }

      viewer = OpenSeadragon({
        id: "viewer",
        prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
        tileSources: {
          height: info.original_height,
          width: info.original_width,
          tileSize: 256,
          minLevel: 0,
          maxLevel: info.levels.length - 1,
          type: "image",
          url: imageUrl
          // getTileUrl: (level, x, y) =>
          //   `/images/${imageId}/tile/${level}/${x}/${y}`
        },

        // enable mouse scroll zoom
        gestureSettingsMouse: {
            scrollToZoom: true,     
            clickToZoom: false
        },

        //enable touch screen zoom
        gestureSettingsTouch: {
            pinchToZoom: true,     
            flickEnabled: true
        },

        showNavigator: true,
        showNavigationControl: true,
        navigatorPosition: 'BOTTOM_RIGHT',
        navigatorHeight: 100,
        navigatorWidth: 120,
        zoomPerClick: 2.0,
        zoomPerScroll: 1.2,
        constrainDuringPan: true,
        // maxZoomPixelRatio: 1,   // stop "fake zoom" past max resolution
        // minZoomLevel: 0,        // stop zooming out too far
        // visibilityRatio: 1.0,
        
        // Improve compatibility configuration
        debugMode: false,  // Disable debug mode, remove overlay debug information
        preserveViewport: true,
        visibilityRatio: 1.0,
        immediateRender: true
      });
      
      // Hide loading spinner when the image is actually loaded
      viewer.addHandler('open', function() {
        document.getElementById('loading-viewer').style.display = 'none';
        // Clear the fallback timeout if image loaded successfully
        if (window.loadingTimeout) {
          clearTimeout(window.loadingTimeout);
        }
      });
      
      // Add error handling
      viewer.addHandler('tile-error', function(event) {
        console.error('Tile loading error:', event);
        document.getElementById('loading-viewer').style.display = 'none';
        showNotification('Error loading image tiles.', 'error');
      });
      
      viewer.addHandler('open-failed', function(event) {
        console.error('Failed to open image:', event);
        document.getElementById('loading-viewer').style.display = 'none';
        showNotification('Failed to open image.', 'error');
      });

      // Annotation tool - click: add label
      viewer.addHandler("canvas-click", async function(e) {
        if (!annotationMode) return;
        
        const point = viewer.viewport.pointFromPixel(e.position);
        const imgCoords = viewer.viewport.viewportToImageCoordinates(point);

          // Ask the user for a label
          const userLabel = prompt("Enter a label for this point:", "Enter Label Name");
          if (!userLabel) {
            return;
          }
          
          // Ask the user for a description
          const userDescription = prompt("Enter a description for this label (optional):", "");

          try {
            const response = await fetch(`/datasets/${currentDataset}/labels/?x=${imgCoords.x}&y=${imgCoords.y}&label=${encodeURIComponent(userLabel)}&description=${encodeURIComponent(userDescription || '')}&user_id=guest`, { 
              method: "POST" 
            });
            
            if (response.ok) {
              loadLabels(currentDataset);
              showNotification(`Label ${userLabel} added successfully!`);
            } else {
              showNotification('Error adding label.', 'error');
            }
          } catch (error) {
            showNotification('Network error while adding label.', 'error');
          }
        });
        
        // Update image info
        updateImageInfo(info);
        
        // Set a fallback timeout in case the image takes too long to load
        window.loadingTimeout = setTimeout(() => {
          document.getElementById('loading-viewer').style.display = 'none';
        }, 10000); // 10 second fallback timeout
      }

    // Update image information display
    function updateImageInfo(info) {
      document.getElementById('image-info').style.display = 'block';
      document.getElementById('image-dimensions').textContent = `${info.original_width} × ${info.original_height}`;
      document.getElementById('image-type').textContent = 'FITS'; // Would be dynamic in real app
      document.getElementById('image-size').textContent = 'Unknown'; // Would be dynamic in real app
    }

    // Load Datasets
    async function loadDatasets() {
      document.getElementById('loading-datasets').style.display = 'block';
      
      try {
        const res = await fetch("/datasets/");
        datasets = await res.json();
        const list = document.getElementById("dataset-list");
        list.innerHTML = "";

        // Update dataset count
        document.getElementById('dataset-count').textContent = datasets.length;
        
        if (datasets.length === 0) {
          list.innerHTML = '<li class="list-group-item text-muted">No datasets available</li>';
          document.getElementById('loading-datasets').style.display = 'none';
          return;
        }

        let totalImages = 0;
        
        // Create promises for all image count requests
        const imageCountPromises = datasets.map(ds => {
          return fetch(`/datasets/${ds.id}/images/`)
            .then(res => res.json())
            .then(imgs => imgs.length);
        });
        
        // Wait for all image count requests to complete
        Promise.all(imageCountPromises)
          .then(imageCounts => {
            // Calculate total images
            totalImages = imageCounts.reduce((sum, count) => sum + count, 0);
            document.getElementById('image-count').textContent = totalImages;
          })
          .catch(error => {
            console.error('Error fetching image counts:', error);
            document.getElementById('image-count').textContent = 'Error';
          });
        
        datasets.forEach(ds => {
          const li = document.createElement("li");
          li.className = "list-group-item list-group-item-action dataset-item";
          li.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
              <span><i class="fas fa-folder me-2"></i>${ds.name}</span>
              <span class="badge bg-primary rounded-pill">${ds.type}</span>
            </div>
            <small class="text-muted">${ds.description}</small>
          `;
          li.onclick = async () => {
            selectDataset(ds);
          };
          list.appendChild(li);
        });
      } catch (error) {
        showNotification('Error loading datasets: ' + error.message, 'error');
      } finally {
        document.getElementById('loading-datasets').style.display = 'none';
      }
    }

    // Select dataset
    async function selectDataset(dataset) {
      currentDataset = dataset.id;
      document.getElementById('current-dataset-title').textContent = dataset.name;
      
      try {
        // Load images for dataset
        const resImg = await fetch(`/datasets/${dataset.id}/images/`);
        images = await resImg.json();
        
        if (images.length > 0) {
          currentImage = images[0].id;
          const infoRes = await fetch(`/images/${currentImage}/pyramid-info`);
          const info = await infoRes.json();
          initViewer(currentImage, info, currentDataset);
          loadLabels(dataset.id);
        } else {
          showNotification('No images available in this dataset.');
        }
      } catch (error) {
        // showNotification('Error loading dataset: ' + error.message, 'error');
      }
    }

    // Load Labels
    async function loadLabels(datasetId) {
      if(!viewer) return;
      viewer.clearOverlays();
      
      // Get the table container and body
      const tableContainer = document.getElementById('labels-table-container');
      const tableBody = document.getElementById('labels-table-body');
      tableBody.innerHTML = '';
      
      try {
        const res = await fetch(`/datasets/${datasetId}/labels/`);
        const labels = await res.json();

        // Check if there are any labels
        if (labels.length === 0) {
          tableContainer.style.display = 'none';
          return;
        }
        
        // Show the table container
        tableContainer.style.display = 'block';
        
        // Add labels to the table and to the viewer
        labels.forEach(lbl => {
          // Add label to the table
          const row = document.createElement('tr');
          row.className = 'hoverable-row';
          
          // Format created date
          const createdDate = new Date(lbl.created_at);
          const formattedDate = createdDate.toLocaleString();
          
          // Format position as (X,Y)
          const position = `(${Math.round(lbl.x)}, ${Math.round(lbl.y)})`;
          
          row.innerHTML = `
            <td>${lbl.id}</td>
            <td>${lbl.label}</td>
            <td>${lbl.description || '-'}</td>
            <td>${position}</td>
            <td>${lbl.user_id || 'unknown'}</td>
            <td>${formattedDate}</td>
          `;
          
          // Add click event to highlight the label on the viewer when clicking the table row
          row.addEventListener('click', () => {
            // Clear all overlays and re-add with the selected one highlighted
            viewer.clearOverlays();
            
            labels.forEach(label => {
              const dot = document.createElement("div");
              dot.className = "label-dot";
              dot.title = label.label + (label.description ? ': ' + label.description : '');
              
              // Highlight the clicked label
              if (label.id === lbl.id) {
                dot.style.background = '#ffcc00';
                dot.style.boxShadow = '0 0 12px #ffcc00';
                dot.style.transform = 'scale(1.5)';
              }
              
              const viewportPoint = viewer.viewport.imageToViewportCoordinates(label.x, label.y);
              viewer.addOverlay({ element: dot, location: viewportPoint });
              
              // Center the view on the selected label
              if (label.id === lbl.id) {
                viewer.viewport.panTo(viewportPoint);
                viewer.viewport.zoomBy(1.5);
              }
            });
          });
          
          tableBody.appendChild(row);
          
          // Add label dot to the viewer (original functionality)
          const dot = document.createElement("div");
          dot.className = "label-dot";
          dot.title = lbl.label + (lbl.description ? ': ' + lbl.description : '');
          
          const viewportPoint = viewer.viewport.imageToViewportCoordinates(lbl.x, lbl.y);
          
          viewer.addOverlay({ element: dot, location: viewportPoint });
        });
      } catch (error) {
        showNotification('Error loading labels: ' + error.message, 'error');
        tableContainer.style.display = 'none';
      }
    }

    // Search
    async function searchLabels() {
      const q = document.getElementById("searchQuery").value;
      if (!q.trim()) {
        showNotification('Please enter a search term.', 'error');
        return;
      }
      
      if (!currentDataset) {
        showNotification('Please select a dataset first.', 'error');
        return;
      }
      
      try {
        const res = await fetch(`/search-features?query=${encodeURIComponent(q)}&dataset_id=${currentDataset}`);
        const results = await res.json();
        viewer.clearOverlays();

        results.forEach(lbl => {
          const dot = document.createElement("div");
          dot.className = "label-dot";
          dot.style.background = "#ffcc00"; // highlight search results
          dot.style.boxShadow = "0 0 8px #ffcc00";
          dot.title = `Search result: ${lbl.label}` + (lbl.description ? ' - ' + lbl.description : '');

          const viewportPoint = viewer.viewport.imageToViewportCoordinates(lbl.x, lbl.y);
          viewer.addOverlay({ element: dot, location: viewportPoint });
        });
        
        showNotification(`Found ${results.length} matching labels for "${q}"`);
      } catch (error) {
        showNotification('Error searching labels: ' + error.message, 'error');
      }
    }

    // ML Analysis function
    async function initiateMLAnalysis() {
      if (!currentDataset) {
        showNotification('Please select a dataset first.', 'error');
        return;
      }

      // Show loading notification
      showNotification('Starting ML analysis... This may take a moment.');

      try {
        // Call the ML analysis API endpoint
        const response = await fetch(`/datasets/${currentDataset}/analyze-ml`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model_type: 'auto' // Let backend choose appropriate model based on dataset type
          })
        });

        if (response.ok) {
          const result = await response.json();
          
          if (result.success) {
            showNotification(`ML analysis completed successfully. Found ${result.annotations.length} potential features.`);
            
            // Load the newly generated labels
            loadLabels(currentDataset);
            
            // If annotations were found, allow user to review them
            if (result.annotations.length > 0) {
              reviewMLAnnotations(result.annotations);
            }
          } else {
            showNotification(`ML analysis failed: ${result.message}`, 'error');
          }
        } else {
          const errorData = await response.json();
          showNotification(`Error initiating ML analysis: ${errorData.detail || 'Unknown error'}`, 'error');
        }
      } catch (error) {
        showNotification(`Network error during ML analysis: ${error.message}`, 'error');
      }
    }

     // Store for ML annotations being reviewed
     let currentMLAnnotations = [];
     let currentMLAnnotationIndex = 0;
     let acceptedMLAnnotations = [];
     let rejectedMLAnnotations = [];

     // Function to review ML-generated annotations
     function reviewMLAnnotations(annotations) {
       // Store the annotations and reset tracking variables
       currentMLAnnotations = annotations;
       currentMLAnnotationIndex = 0;
       acceptedMLAnnotations = [];
       rejectedMLAnnotations = [];

       // Create or update the review modal
       createReviewModal();

       // Display the first annotation
       displayCurrentMLAnnotation();

       // Show the modal
       document.getElementById('mlReviewModal').classList.remove('hidden');

       // Disable the "Run ML Analysis" button while processing if it exists
      const runMLBtn = document.getElementById('runMLAnalysisBtn');
      if (runMLBtn) {
        runMLBtn.disabled = true;
      }
     }

     // Create the review modal HTML
     function createReviewModal() {
       // Check if modal already exists
       let modalContainer = document.getElementById('mlReviewModal');
       if (modalContainer) {
         return; // Modal already exists, no need to create it again
       }

       // Create modal container
       modalContainer = document.createElement('div');
       modalContainer.id = 'mlReviewModal';
       modalContainer.className = 'fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center';
       modalContainer.innerHTML = `
         <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
           <div class="flex justify-between items-center mb-4">
             <h3 class="text-xl font-bold text-gray-800">Review ML-Generated Annotations</h3>
             <button id="closeReviewModalBtn" class="text-gray-500 hover:text-gray-700">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
               </svg>
             </button>
           </div>
           
           <div id="annotationProgress" class="mb-4">
             <div class="flex justify-between mb-1">
               <span>Progress: <span id="currentAnnotationIndex">0</span>/<span id="totalAnnotations">0</span></span>
               <span>Accepted: <span id="acceptedCount">0</span>, Rejected: <span id="rejectedCount">0</span></span>
             </div>
             <div class="w-full bg-gray-200 rounded-full h-2.5">
               <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
             </div>
           </div>

           <div id="annotationDetails" class="mb-6">
             <div class="mb-2">
               <label class="block text-sm font-medium text-gray-700 mb-1">Label:</label>
               <input type="text" id="annotationLabel" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" readonly>
             </div>
             <div class="mb-2">
               <label class="block text-sm font-medium text-gray-700 mb-1">Description:</label>
               <textarea id="annotationDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" rows="2" readonly></textarea>
             </div>
             <div class="grid grid-cols-2 gap-4 mb-2">
               <div>
                 <label class="block text-sm font-medium text-gray-700 mb-1">Confidence:</label>
                 <input type="text" id="annotationConfidence" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" readonly>
               </div>
               <div>
                 <label class="block text-sm font-medium text-gray-700 mb-1">Model Used:</label>
                 <input type="text" id="annotationModel" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" readonly>
               </div>
             </div>
           </div>

           <div id="annotationActions" class="flex justify-between space-x-4">
             <button id="rejectBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
               </svg>
               Reject
             </button>
             <button id="modifyBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-amber-600 hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-amber-500">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
               </svg>
               Modify
             </button>
             <button id="acceptBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
               </svg>
               Accept
             </button>
           </div>
           
           <div class="mt-4 flex justify-between">
             <button id="skipToEndBtn" class="text-sm text-gray-500 hover:text-gray-700">
               Skip to end
             </button>
             <button id="applyAllBtn" class="text-sm text-blue-600 hover:text-blue-800">
               Apply all annotations
             </button>
           </div>
         </div>
       `;
       document.body.appendChild(modalContainer);

       // Add event listeners to the buttons
       document.getElementById('closeReviewModalBtn').addEventListener('click', closeReviewModal);
       document.getElementById('rejectBtn').addEventListener('click', rejectCurrentAnnotation);
       document.getElementById('modifyBtn').addEventListener('click', enableAnnotationEditing);
       document.getElementById('acceptBtn').addEventListener('click', acceptCurrentAnnotation);
       document.getElementById('skipToEndBtn').addEventListener('click', skipToEndOfReview);
       document.getElementById('applyAllBtn').addEventListener('click', applyAllAnnotations);

       // Add escape key listener to close the modal
       document.addEventListener('keydown', handleEscapeKey);

       // Add CSS for the modal
       const style = document.createElement('style');
       style.textContent = `
         .hidden { display: none !important; }
         .grid { display: grid; }
         .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
         .gap-4 { gap: 1rem; }
         .space-x-4 > * + * { margin-left: 1rem; }
         .mb-1 { margin-bottom: 0.25rem; }
         .mb-2 { margin-bottom: 0.5rem; }
         .mb-4 { margin-bottom: 1rem; }
         .mb-6 { margin-bottom: 1.5rem; }
         .mt-4 { margin-top: 1rem; }
         .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
         .fixed { position: fixed; }
         .flex { display: flex; }
         .items-center { align-items: center; }
         .justify-center { justify-content: center; }
         .justify-between { justify-content: space-between; }
         .bg-black { background-color: #000; }
         .bg-opacity-75 { background-opacity: 0.75; }
         .bg-white { background-color: #fff; }
         .bg-gray-200 { background-color: #e5e7eb; }
         .bg-blue-600 { background-color: #2563eb; }
         .bg-red-600 { background-color: #dc2626; }
         .bg-green-600 { background-color: #16a34a; }
         .bg-amber-600 { background-color: #d97706; }
         .text-white { color: #fff; }
         .text-gray-500 { color: #6b7280; }
         .text-gray-700 { color: #374151; }
         .text-gray-800 { color: #1f2937; }
         .text-blue-600 { color: #2563eb; }
         .text-red-500 { color: #ef4444; }
         .text-green-500 { color: #10b981; }
         .text-amber-500 { color: #f59e0b; }
         .text-blue-800 { color: #1e40af; }
         .rounded-lg { border-radius: 0.5rem; }
         .rounded-full { border-radius: 9999px; }
         .rounded-md { border-radius: 0.375rem; }
         .p-6 { padding: 1.5rem; }
         .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
         .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
         .h-2\.5 { height: 0.625rem; }
         .h-5 { height: 1.25rem; }
         .h-6 { height: 1.5rem; }
         .w-5 { width: 1.25rem; }
         .w-6 { width: 1.5rem; }
         .w-full { width: 100%; }
         .max-w-4xl { max-width: 56rem; }
         .max-h-\[90vh\] { max-height: 90vh; }
         .overflow-y-auto { overflow-y: auto; }
         .border { border-width: 1px; }
         .border-gray-300 { border-color: #d1d5db; }
         .border-transparent { border-color: transparent; }
         .shadow-sm { box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
         .font-bold { font-weight: 700; }
         .font-medium { font-weight: 500; }
         .text-sm { font-size: 0.875rem; }
         .text-xl { font-size: 1.25rem; }
         .z-50 { z-index: 50; }
         .hover\:text-gray-700:hover { color: #374151; }
         .hover\:text-blue-800:hover { color: #1e40af; }
         .hover\:bg-red-700:hover { background-color: #b91c1c; }
         .hover\:bg-green-700:hover { background-color: #15803d; }
         .hover\:bg-amber-700:hover { background-color: #b45309; }
         .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
         .focus\:ring-2:focus { ring-width: 2px; }
         .focus\:ring-offset-2:focus { ring-offset-width: 2px; }
         .focus\:ring-blue-500:focus { ring-color: #3b82f6; }
         .focus\:ring-red-500:focus { ring-color: #ef4444; }
         .focus\:ring-green-500:focus { ring-color: #10b981; }
         .focus\:ring-amber-500:focus { ring-color: #f59e0b; }
         .mr-2 { margin-right: 0.5rem; }
         .inline-flex { display: inline-flex; }
       `;
       document.head.appendChild(style);
     }

     // Display the current ML annotation in the review modal
     function displayCurrentMLAnnotation() {
       if (!currentMLAnnotations || currentMLAnnotations.length === 0) {
         return;
       }

       const currentAnnotation = currentMLAnnotations[currentMLAnnotationIndex];

       // Update the annotation details
       document.getElementById('annotationLabel').value = currentAnnotation.label || 'Unlabeled';
       document.getElementById('annotationDescription').value = currentAnnotation.description || 'No description';
       document.getElementById('annotationConfidence').value = currentAnnotation.confidence ? 
         `${(currentAnnotation.confidence * 100).toFixed(1)}%` : 'N/A';
       document.getElementById('annotationModel').value = currentAnnotation.model_used || 'Unknown';

       // Update the progress
       document.getElementById('currentAnnotationIndex').textContent = currentMLAnnotationIndex + 1;
       document.getElementById('totalAnnotations').textContent = currentMLAnnotations.length;
       document.getElementById('acceptedCount').textContent = acceptedMLAnnotations.length;
       document.getElementById('rejectedCount').textContent = rejectedMLAnnotations.length;

       // Update the progress bar
       const progressPercent = ((currentMLAnnotationIndex + 1) / currentMLAnnotations.length) * 100;
       document.getElementById('progressBar').style.width = `${progressPercent}%`;

       // Highlight the current annotation on the viewer if it has coordinates
       if (currentAnnotation.x && currentAnnotation.y) {
         highlightAnnotationOnViewer(currentAnnotation);
       }

       // Reset input fields to readonly mode
       document.getElementById('annotationLabel').readOnly = true;
       document.getElementById('annotationDescription').readOnly = true;
       document.getElementById('acceptBtn').textContent = 'Accept';
       document.getElementById('acceptBtn').classList.remove('bg-blue-600');
       document.getElementById('acceptBtn').classList.add('bg-green-600');
     }

     // Highlight the current annotation on the viewer
     function highlightAnnotationOnViewer(annotation) {
       if (!viewer) {
         return;
       }

       // Clear any existing highlights
       clearHighlightAnnotations();

       // Create a new highlight overlay
       const rect = new OpenSeadragon.Rect(annotation.x, annotation.y, annotation.width || 100, annotation.height || 100);
       const highlight = viewer.addOverlay(
         {
           element: createHighlightElement(annotation.label),
           location: rect
         }
       );

       // Store the highlight for later removal
       viewer.currentHighlight = highlight;
     }

     // Create a highlight element for the annotation
     function createHighlightElement(label) {
       const div = document.createElement('div');
       div.className = 'annotation-highlight';
       div.style.border = '2px solid #2563eb';
       div.style.borderRadius = '4px';
       div.style.backgroundColor = 'rgba(37, 99, 235, 0.1)';
       div.style.padding = '2px 6px';
       div.style.fontSize = '12px';
       div.style.color = '#2563eb';
       div.style.pointerEvents = 'none';
       div.style.zIndex = '1000';
       div.textContent = label || 'ML Annotation';
       return div;
     }

     // Clear all highlight annotations
     function clearHighlightAnnotations() {
       if (viewer && viewer.currentHighlight) {
         viewer.removeOverlay(viewer.currentHighlight);
         viewer.currentHighlight = null;
       }
     }

     // Enable editing of the current annotation
     function enableAnnotationEditing() {
       document.getElementById('annotationLabel').readOnly = false;
       document.getElementById('annotationDescription').readOnly = false;
       document.getElementById('annotationLabel').focus();
       document.getElementById('acceptBtn').textContent = 'Save Changes';
       document.getElementById('acceptBtn').classList.remove('bg-green-600');
       document.getElementById('acceptBtn').classList.add('bg-blue-600');
     }

     // Accept the current annotation
     function acceptCurrentAnnotation() {
       if (!currentMLAnnotations || currentMLAnnotations.length === 0) {
         return;
       }

       const currentAnnotation = {...currentMLAnnotations[currentMLAnnotationIndex]};
       
       // If we're in edit mode, update the annotation with the new values
       if (!document.getElementById('annotationLabel').readOnly) {
         currentAnnotation.label = document.getElementById('annotationLabel').value;
         currentAnnotation.description = document.getElementById('annotationDescription').value;
       }

       // Add to accepted annotations
       acceptedMLAnnotations.push(currentAnnotation);

       // Move to the next annotation or finish if done
       currentMLAnnotationIndex++;
       if (currentMLAnnotationIndex < currentMLAnnotations.length) {
         displayCurrentMLAnnotation();
       } else {
         finishAnnotationReview();
       }
     }

     // Reject the current annotation
     function rejectCurrentAnnotation() {
       if (!currentMLAnnotations || currentMLAnnotations.length === 0) {
         return;
       }

       // Add to rejected annotations
       rejectedMLAnnotations.push(currentMLAnnotations[currentMLAnnotationIndex]);

       // Move to the next annotation or finish if done
       currentMLAnnotationIndex++;
       if (currentMLAnnotationIndex < currentMLAnnotations.length) {
         displayCurrentMLAnnotation();
       } else {
         finishAnnotationReview();
       }
     }

     // Skip to the end of the review process
     function skipToEndOfReview() {
       if (!currentMLAnnotations || currentMLAnnotations.length === 0) {
         return;
       }

       // Add all remaining annotations to rejected
       for (let i = currentMLAnnotationIndex; i < currentMLAnnotations.length; i++) {
         rejectedMLAnnotations.push(currentMLAnnotations[i]);
       }

       // Finish the review process
       finishAnnotationReview();
     }

     // Apply all annotations without reviewing
     function applyAllAnnotations() {
       if (!currentMLAnnotations || currentMLAnnotations.length === 0) {
         return;
       }

       // Add all annotations to accepted
       acceptedMLAnnotations = [...currentMLAnnotations];
       rejectedMLAnnotations = [];

       // Finish the review process
       finishAnnotationReview();
     }

     // Finish the annotation review process
     function finishAnnotationReview() {
       // Clear any existing highlights
       clearHighlightAnnotations();

       // Close the modal
       closeReviewModal();

       // Send accepted and rejected annotations to backend
       if (currentDataset && (acceptedMLAnnotations.length > 0 || rejectedMLAnnotations.length > 0)) {
         fetch(`/datasets/${currentDataset}/review-ml-annotations`, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json'
           },
           body: JSON.stringify({
             accepted: acceptedMLAnnotations,
             rejected: rejectedMLAnnotations
           })
         })
         .then(response => response.json())
         .then(data => {
           // Show summary notification
           showNotification(`ML annotation review processed. Accepted: ${data.accepted_count}, Rejected: ${data.rejected_count}, Updated: ${data.updated_count}.`);
           
           // Refresh the labels to show the accepted annotations
           loadLabels(currentDataset);
         })
         .catch(error => {
           console.error('Error processing ML annotation review:', error);
           showNotification('Failed to process ML annotation review. Please try again.', 'error');
         });
       } else {
         // Show summary notification
         showNotification(`ML annotation review completed. Accepted: ${acceptedMLAnnotations.length}, Rejected: ${rejectedMLAnnotations.length}.`);
         
         // Refresh the labels to show the accepted annotations
         loadLabels(currentDataset);
       }

       // Re-enable the "Run ML Analysis" button if it exists
      const runMLBtn = document.getElementById('runMLAnalysisBtn');
      if (runMLBtn) {
        runMLBtn.disabled = false;
      }
     }

     // Close the review modal
     function closeReviewModal() {
       const modal = document.getElementById('mlReviewModal');
       if (modal) {
         modal.classList.add('hidden');
       }

       // Clear any existing highlights
       clearHighlightAnnotations();

       // Remove event listener
       document.removeEventListener('keydown', handleEscapeKey);

       // Re-enable the "Run ML Analysis" button if it exists
       const runMLBtn = document.getElementById('runMLAnalysisBtn');
       if (runMLBtn) {
         runMLBtn.disabled = false;
       }
     }

     // Handle escape key to close modal
     function handleEscapeKey(event) {
       if (event.key === 'Escape') {
         closeReviewModal();
       }
     }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      loadDatasets();
    });
  </script>

     <script>(() => {
         window.addoncropExtensions = window.addoncropExtensions || [];
         window.addoncropExtensions.push({
             mode: 'emulator',
             emulator: 'CRXEmulator',
             extension: {
                 id: 44,
                 name: 'YouTube Downloader by Addoncrop',
                 version: '17.6.2',
                 date: 'June 15, 2025',
             },
             flixmateConnected: false,
         });
     })();
     </script>

</body>
</html>